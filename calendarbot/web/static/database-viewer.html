<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalendarBot - Database Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e5e7;
        }
        
        .panel-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1d1d1f;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }
        
        .query-section {
            display: grid;
            gap: 20px;
        }
        
        .table-selector-container {
            display: flex;
            align-items: center;
            padding: 10px 0;
        }
        
        .table-selector {
            padding: 8px 12px;
            border: 2px solid #e5e5e7;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'SF Mono', Monaco, monospace;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s ease;
            min-width: 200px;
        }
        
        .table-selector:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .query-input {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #e5e5e7;
            border-radius: 8px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            transition: border-color 0.2s ease;
        }
        
        .query-input:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #007aff;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #f1f1f3;
            color: #1d1d1f;
            border: 1px solid #d1d1d6;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #e8e8ed;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .sample-queries {
            display: grid;
            gap: 10px;
        }
        
        .sample-query {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
        }
        
        .sample-query:hover {
            background: #e9ecef;
            border-color: #007aff;
        }
        
        .results-container {
            margin-top: 25px;
        }
        
        .results-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .results-table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e5e5e7;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        .results-table th {
            background: #f8f9fa;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e5e5e7;
            font-size: 14px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f1f1f3;
            font-size: 14px;
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .results-table tr:nth-child(even) {
            background-color: #fafafa;
        }
        
        .results-table tr:hover {
            background-color: #f0f8ff;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .alert-error {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            color: #c53030;
        }
        
        .alert-success {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #2f855a;
        }
        
        .alert-info {
            background: #ebf8ff;
            border: 1px solid #90cdf4;
            color: #2b6cb0;
        }
        
        .loading {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007aff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        .database-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .info-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .info-card h4 {
            font-size: 14px;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .info-card p {
            font-size: 18px;
            font-weight: 600;
            color: #1d1d1f;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .panel {
                padding: 20px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                justify-content: center;
            }
            
            .results-info {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Database Viewer</h1>
            <p>Explore and query the CalendarBot cache database</p>
        </div>

        <!-- Database Information Panel -->
        <div class="panel">
            <div class="panel-title">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
                Database Information
            </div>
            <div id="database-info" class="database-info">
                <div class="info-card">
                    <h4>Status</h4>
                    <p id="db-status">Loading...</p>
                </div>
                <div class="info-card">
                    <h4>Tables</h4>
                    <p id="db-tables">-</p>
                </div>
                <div class="info-card">
                    <h4>Total Records</h4>
                    <p id="db-records">-</p>
                </div>
                <div class="info-card">
                    <h4>Last Updated</h4>
                    <p id="db-updated">-</p>
                </div>
            </div>
        </div>

        <!-- Query Panel -->
        <div class="panel">
            <div class="panel-title">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                </svg>
                SQL Query
            </div>
            
            <div class="query-section">
                <div class="table-selector-container">
                    <label for="table-selector" style="font-weight: 500; margin-right: 10px;">Default Table:</label>
                    <select id="table-selector" class="table-selector">
                        <option value="">Loading tables...</option>
                    </select>
                </div>
                
                <textarea 
                    id="query-input" 
                    class="query-input" 
                    placeholder="Enter your SQL query here...&#10;&#10;Example: SELECT * FROM cached_events LIMIT 10;"
                ></textarea>
                
                <div class="button-group">
                    <button id="execute-btn" class="btn btn-primary">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M8,5.14V19.14L19,12.14L8,5.14Z"/>
                        </svg>
                        Execute Query
                    </button>
                    <button id="clear-btn" class="btn btn-secondary">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                        </svg>
                        Clear
                    </button>
                    <button id="tables-btn" class="btn btn-secondary">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M5,4H7V6H5V4M9,4H11V6H9V4M13,4H15V6H13V4M17,4H19V6H17V4M5,8H7V10H5V8M9,8H11V10H9V8M13,8H15V10H13V8M17,8H19V10H17V8M5,12H7V14H5V12M9,12H11V14H9V12M13,12H15V14H13V12M17,12H19V14H17V12M5,16H7V18H5V16M9,16H11V18H9V16M13,16H15V18H13V16M17,16H19V18H17V16M5,20H7V22H5V20M9,20H11V22H9V20M13,20H15V22H13V20M17,20H19V22H17V20Z"/>
                        </svg>
                        Show Tables
                    </button>
                </div>
            </div>
        </div>

        <!-- Sample Queries Panel -->
        <div class="panel">
            <div class="panel-title">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                </svg>
                Sample Queries
            </div>
            
            <div class="sample-queries">
                <div class="sample-query" data-query="SELECT * FROM cached_events WHERE date(start_dt) = date('now', 'localtime') ORDER BY start_dt;">
                    📅 Show today's events: SELECT * FROM cached_events WHERE date(start_dt) = date('now', 'localtime') ORDER BY start_dt;
                </div>
                <div class="sample-query" data-query="SELECT * FROM cached_events LIMIT 10;">
                    📋 Show recent events: SELECT * FROM cached_events LIMIT 10;
                </div>
                <div class="sample-query" data-query="SELECT COUNT(*) as total_events FROM cached_events;">
                    📊 Count total events: SELECT COUNT(*) as total_events FROM cached_events;
                </div>
                <div class="sample-query" data-query="SELECT * FROM cache_metadata;">
                    ⚙️ View cache metadata: SELECT * FROM cache_metadata;
                </div>
                <div class="sample-query" data-query="SELECT name, type FROM sqlite_master WHERE type='table';">
                    🗂️ List all tables: SELECT name, type FROM sqlite_master WHERE type='table';
                </div>
                <div class="sample-query" data-query="PRAGMA table_info(cached_events);">
                    🔍 Show events table structure: PRAGMA table_info(cached_events);
                </div>
            </div>
        </div>

        <!-- Results Panel -->
        <div id="results-panel" class="panel hidden">
            <div class="panel-title">
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M5,4H7V6H5V4M9,4H11V6H9V4M13,4H15V6H13V4M17,4H19V6H17V4M5,8H7V10H5V8M9,8H11V10H9V8M13,8H15V10H13V8M17,8H19V10H17V8M5,12H7V14H5V12M9,12H11V14H9V12M13,12H15V14H13V12M17,12H19V14H17V12M5,16H7V18H5V16M9,16H11V18H9V16M13,16H15V18H13V16M17,16H19V18H17V16M5,20H7V22H5V20M9,20H11V22H9V20M13,20H15V22H13V20M17,20H19V22H17V20Z"/>
                </svg>
                Query Results
            </div>
            <div id="results-container" class="results-container"></div>
        </div>
    </div>

    <script>
        class DatabaseViewer {
            constructor() {
                this.currentTable = 'cached_events'; // Default table
                this.tables = [];
                this.initializeElements();
                this.bindEvents();
                this.loadDatabaseInfo();
                this.loadTables();
            }

            initializeElements() {
                this.queryInput = document.getElementById('query-input');
                this.executeBtn = document.getElementById('execute-btn');
                this.clearBtn = document.getElementById('clear-btn');
                this.tablesBtn = document.getElementById('tables-btn');
                this.resultsPanel = document.getElementById('results-panel');
                this.resultsContainer = document.getElementById('results-container');
                this.sampleQueries = document.querySelectorAll('.sample-query');
                this.tableSelector = document.getElementById('table-selector');
            }

            bindEvents() {
                this.executeBtn.addEventListener('click', () => this.executeQuery());
                this.clearBtn.addEventListener('click', () => this.clearQuery());
                this.tablesBtn.addEventListener('click', () => this.showTables());
                
                // Table selector change event
                this.tableSelector.addEventListener('change', (e) => {
                    this.currentTable = e.target.value;
                    if (this.currentTable) {
                        // Update placeholder with selected table
                        this.queryInput.placeholder = `Enter your SQL query here...\n\nExample: SELECT * FROM ${this.currentTable} LIMIT 10;`;
                    }
                });
                
                this.sampleQueries.forEach(query => {
                    query.addEventListener('click', () => {
                        const sql = query.getAttribute('data-query');
                        this.queryInput.value = sql;
                    });
                });

                // Allow Ctrl+Enter to execute query
                this.queryInput.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'Enter') {
                        this.executeQuery();
                    }
                });
            }

            async loadDatabaseInfo() {
                try {
                    const response = await fetch('/api/database/info');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.updateDatabaseInfo(data.data);
                    } else {
                        this.showError('Failed to load database information');
                    }
                } catch (error) {
                    this.showError('Error connecting to database: ' + error.message);
                }
            }

            updateDatabaseInfo(info) {
                document.getElementById('db-status').textContent = 'Connected';
                document.getElementById('db-tables').textContent = info.tables_count || '-';
                document.getElementById('db-records').textContent = info.total_records || '-';
                document.getElementById('db-updated').textContent = 
                    info.last_updated ? new Date(info.last_updated).toLocaleString() : '-';
            }

            async executeQuery() {
                const query = this.queryInput.value.trim();
                if (!query) {
                    this.showError('Please enter a SQL query');
                    return;
                }

                this.setLoading(true);
                this.clearResults();

                try {
                    const response = await fetch('/api/database/query', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ query: query })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        this.displayResults(data.data, query);
                    } else {
                        this.showError(data.error || 'Query execution failed');
                    }
                } catch (error) {
                    this.showError('Network error: ' + error.message);
                } finally {
                    this.setLoading(false);
                }
            }

            async showTables() {
                try {
                    const response = await fetch('/api/database/tables');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.displayResults(data.data, 'SHOW TABLES');
                    } else {
                        this.showError('Failed to load tables');
                    }
                } catch (error) {
                    this.showError('Error loading tables: ' + error.message);
                }
            }

            displayResults(results, query) {
                this.resultsPanel.classList.remove('hidden');
                
                const container = this.resultsContainer;
                container.innerHTML = '';

                // Show query info
                const infoDiv = document.createElement('div');
                infoDiv.className = 'results-info';
                infoDiv.innerHTML = `
                    <span><strong>Query:</strong> ${this.escapeHtml(query)}</span>
                    <span><strong>Results:</strong> ${results.count} rows</span>
                `;
                container.appendChild(infoDiv);

                if (results.count === 0) {
                    const noResults = document.createElement('div');
                    noResults.className = 'alert alert-info';
                    noResults.innerHTML = `
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M13,9H11V7H13M13,17H11V11H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>
                        </svg>
                        No results returned
                    `;
                    container.appendChild(noResults);
                    return;
                }

                // Create table
                const tableContainer = document.createElement('div');
                tableContainer.className = 'results-table-container';
                
                const table = document.createElement('table');
                table.className = 'results-table';

                // Table header
                if (results.columns && results.columns.length > 0) {
                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    
                    results.columns.forEach(column => {
                        const th = document.createElement('th');
                        th.textContent = column;
                        headerRow.appendChild(th);
                    });
                    
                    thead.appendChild(headerRow);
                    table.appendChild(thead);
                }

                // Table body
                const tbody = document.createElement('tbody');
                
                results.rows.forEach(row => {
                    const tr = document.createElement('tr');
                    
                    if (results.columns) {
                        results.columns.forEach(column => {
                            const td = document.createElement('td');
                            const value = row[column];
                            td.textContent = value !== null && value !== undefined ? String(value) : '';
                            tr.appendChild(td);
                        });
                    } else {
                        // Fallback for rows without column info
                        Object.values(row).forEach(value => {
                            const td = document.createElement('td');
                            td.textContent = value !== null && value !== undefined ? String(value) : '';
                            tr.appendChild(td);
                        });
                    }
                    
                    tbody.appendChild(tr);
                });

                table.appendChild(tbody);
                tableContainer.appendChild(table);
                container.appendChild(tableContainer);

                // Scroll to results
                this.resultsPanel.scrollIntoView({ behavior: 'smooth' });
            }

            showError(message) {
                this.resultsPanel.classList.remove('hidden');
                this.resultsContainer.innerHTML = `
                    <div class="alert alert-error">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M13,13H11V7H13M13,17H11V15H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>
                        </svg>
                        <div>
                            <strong>Error:</strong> ${this.escapeHtml(message)}
                        </div>
                    </div>
                `;
                this.resultsPanel.scrollIntoView({ behavior: 'smooth' });
            }

            clearQuery() {
                this.queryInput.value = '';
                this.queryInput.focus();
            }

            clearResults() {
                this.resultsContainer.innerHTML = '';
                this.resultsPanel.classList.add('hidden');
            }

            setLoading(loading) {
                const btn = this.executeBtn;
                if (loading) {
                    btn.disabled = true;
                    btn.innerHTML = `
                        <div class="loading">
                            <div class="spinner"></div>
                            Executing...
                        </div>
                    `;
                } else {
                    btn.disabled = false;
                    btn.innerHTML = `
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M8,5.14V19.14L19,12.14L8,5.14Z"/>
                        </svg>
                        Execute Query
                    `;
                }
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            async loadTables() {
                try {
                    const response = await fetch('/api/database/tables');
                    const data = await response.json();
                    
                    if (data.success && data.data) {
                        this.tables = data.data.rows.map(row => row.name);
                        this.populateTableSelector();
                        // Check raw_events after loading tables
                        this.checkRawEventsTable();
                    }
                } catch (error) {
                    console.error('Failed to load tables:', error);
                    this.tableSelector.innerHTML = '<option value="">Failed to load tables</option>';
                }
            }

            populateTableSelector() {
                this.tableSelector.innerHTML = '';
                
                // Add default option
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '-- Select a table --';
                this.tableSelector.appendChild(defaultOption);
                
                // Add table options
                this.tables.forEach(table => {
                    const option = document.createElement('option');
                    option.value = table;
                    option.textContent = table;
                    if (table === 'cached_events') {
                        option.selected = true;
                        this.currentTable = table;
                    }
                    this.tableSelector.appendChild(option);
                });
            }

            async checkRawEventsTable() {
                // Check if raw_events table exists and has data
                if (!this.tables.includes('raw_events')) {
                    return; // Table doesn't exist
                }
                
                try {
                    const response = await fetch('/api/database/query', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ query: 'SELECT COUNT(*) as count FROM raw_events' })
                    });
                    
                    const data = await response.json();
                    if (data.success && data.data && data.data.rows[0]) {
                        const count = data.data.rows[0].count;
                        if (count === 0) {
                            this.showRawEventsEmptyNotification();
                        }
                    }
                } catch (error) {
                    console.error('Failed to check raw_events:', error);
                }
            }

            showRawEventsEmptyNotification() {
                // Create notification panel
                const notificationDiv = document.createElement('div');
                notificationDiv.className = 'panel';
                notificationDiv.style.background = '#fff3cd';
                notificationDiv.style.border = '1px solid #ffc107';
                notificationDiv.innerHTML = `
                    <div class="panel-title" style="color: #856404;">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M13,13H11V7H13M13,17H11V15H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>
                        </svg>
                        Debug Tool: Raw Events Table Empty
                    </div>
                    <p style="margin: 10px 0;">The raw_events table is empty. Would you like to fetch and populate it with ICS data for debugging?</p>
                    <button id="populate-raw-events-btn" class="btn btn-primary" style="margin-top: 10px;">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z"/>
                        </svg>
                        Fetch ICS Data
                    </button>
                    <div id="ics-fetch-status" style="margin-top: 15px; display: none;">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span id="fetch-status-text">Fetching ICS data...</span>
                        </div>
                    </div>
                `;
                
                // Insert after header, before first panel
                const container = document.querySelector('.container');
                const firstPanel = container.querySelector('.panel');
                container.insertBefore(notificationDiv, firstPanel);
                
                // Bind populate button event
                const populateBtn = document.getElementById('populate-raw-events-btn');
                populateBtn.addEventListener('click', () => this.populateRawEvents(populateBtn));
            }

            async populateRawEvents(button) {
                const statusDiv = document.getElementById('ics-fetch-status');
                const statusText = document.getElementById('fetch-status-text');
                
                // Show loading state
                button.disabled = true;
                statusDiv.style.display = 'block';
                statusText.textContent = 'Fetching ICS data from sources...';
                
                try {
                    // Call backend endpoint to populate raw_events
                    const response = await fetch('/api/database/populate-raw-events', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'}
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        statusText.textContent = `✅ Successfully populated ${data.count || 0} raw events`;
                        statusDiv.querySelector('.spinner').style.display = 'none';
                        
                        // Refresh the page after 2 seconds
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        statusText.textContent = `❌ Failed: ${data.error || 'Unknown error'}`;
                        statusDiv.querySelector('.spinner').style.display = 'none';
                        button.disabled = false;
                    }
                } catch (error) {
                    statusText.textContent = `❌ Error: ${error.message}`;
                    statusDiv.querySelector('.spinner').style.display = 'none';
                    button.disabled = false;
                }
            }
        }

        // Initialize the database viewer when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new DatabaseViewer();
        });
    </script>
</body>
</html>