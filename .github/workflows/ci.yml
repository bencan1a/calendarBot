name: CI/CD Pipeline (Fail-Fast Sequential)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"
  COVERAGE_THRESHOLD: 70

jobs:
  # STAGE 1: Static analysis (fail fast on code quality issues)
  quality:
    name: Code Quality (lint/type/security)
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt', 'pyproject.toml') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -e .[dev] types-pytz types-python-dateutil

    - name: Run linting
      run: venv/bin/python tests/ci_test_runner.py --lint

    - name: Run type checking
      run: venv/bin/python tests/ci_test_runner.py --type-check

    - name: Run security analysis
      run: venv/bin/python tests/ci_test_runner.py --security

  # STAGE 2: Critical path smoke tests (fail fast on core functionality)
  critical-path:
    name: Critical Path Tests (~2min)
    runs-on: ubuntu-latest
    needs: [quality]
    timeout-minutes: 8

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt', 'pyproject.toml') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -e .[dev]

    - name: Run critical path tests
      run: venv/bin/python tests/ci_test_runner.py --critical-path

    - name: Upload critical path coverage
      uses: codecov/codecov-action@v4
      if: always()
      with:
        file: ./coverage.xml
        flags: critical-path
        name: critical-path-coverage

  # STAGE 3: Full test suite WITH coverage (single run, no redundancy)
  full-tests-with-coverage:
    name: Full Test Suite + Coverage (~5min)
    runs-on: ubuntu-latest
    needs: [critical-path]
    timeout-minutes: 45

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt', 'pyproject.toml') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -e .[dev]

    - name: Run full test suite with coverage
      run: |
        venv/bin/python tests/ci_test_runner.py --full-regression

    - name: Generate coverage reports
      run: |
        venv/bin/python tests/ci_test_runner.py --coverage-report

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      if: always()
      with:
        file: ./coverage.xml
        flags: full-suite
        name: full-suite-coverage

    - name: Upload test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          htmlcov/
          coverage.xml
          coverage.json
          pytest-results.xml
        retention-days: 5

  # STAGE 4: Performance validation
  pi-performance-gate:
    name: Pi Zero2 Performance Check (~2min)
    runs-on: ubuntu-latest
    needs: [full-tests-with-coverage]
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt', 'pyproject.toml') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -e .[dev]

    - name: Run Pi Zero2 performance gate (50 events)
      run: |
        venv/bin/python tests/ci_performance_benchmark.py --run fifty --output pi_zero_perf_check.json

    - name: Upload Pi Zero2 performance results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pi-zero2-perf-gate
        path: pi_zero_perf_check.json
        retention-days: 7

  # STAGE 5: Coverage validation (no test execution, just validate reports)
  coverage-validation:
    name: Coverage Validation (~30s)
    runs-on: ubuntu-latest
    needs: [full-tests-with-coverage]
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt', 'pyproject.toml') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -e .[dev]

    - name: Download coverage artifacts
      uses: actions/download-artifact@v4
      with:
        name: test-results

    - name: Validate coverage threshold
      run: |
        # Check that coverage meets minimum threshold
        venv/bin/python -c "
import json
with open('coverage.json') as f:
    cov = json.load(f)
    total = cov['totals']['percent_covered']
    threshold = ${{ env.COVERAGE_THRESHOLD }}
    print(f'Coverage: {total:.2f}% (threshold: {threshold}%)')
    if total < threshold:
        raise SystemExit(f'Coverage {total:.2f}% is below threshold {threshold}%')
"

    - name: Coverage differential analysis
      run: |
        venv/bin/python tests/ci_test_runner.py --coverage-diff

  # STAGE 6: Deployment readiness (final gate)
  deployment-check:
    name: Deployment Readiness
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [quality, critical-path, full-tests-with-coverage, pi-performance-gate, coverage-validation]
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt', 'pyproject.toml') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -e .[dev]

    - name: Validate calendarbot_lite startup
      run: |
        timeout 30 venv/bin/python -m calendarbot_lite --help || true

    - name: Download all artifacts for deployment package
      uses: actions/download-artifact@v4
      with:
        name: test-results

    - name: Upload deployment artifacts
      uses: actions/upload-artifact@v4
      with:
        name: deployment-artifacts
        path: |
          htmlcov/
          coverage.xml
        retention-days: 7
