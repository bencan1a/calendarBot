name: CI/CD Pipeline (Fail-Fast Sequential)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      force_full_suite:
        description: 'Force full test suite (skip smart selection)'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: "3.12"
  COVERAGE_THRESHOLD: 70

jobs:
  # STAGE 1: Static analysis (fail fast on code quality issues)
  quality:
    name: Code Quality (lint/type/security)
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt', 'pyproject.toml') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -e .[dev] types-pytz types-python-dateutil

    - name: Run linting
      run: venv/bin/python tests/ci_test_runner.py --lint

    - name: Run type checking
      run: venv/bin/python tests/ci_test_runner.py --type-check

    - name: Run security analysis
      run: venv/bin/python tests/ci_test_runner.py --security

  # STAGE 2: Critical path smoke tests (fail fast on core functionality)
  critical-path:
    name: Critical Path Tests (~2min)
    runs-on: ubuntu-latest
    needs: [quality]
    timeout-minutes: 8

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt', 'pyproject.toml') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -e .[dev]

    - name: Run critical path tests
      run: venv/bin/python tests/ci_test_runner.py --critical-path

  # STAGE 3: Smart test selection WITH coverage (single run, no redundancy)
  smart-tests-with-coverage:
    name: Smart Test Suite + Coverage (~2-5min)
    runs-on: ubuntu-latest
    needs: [critical-path]
    timeout-minutes: 45

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for smart test selection

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt', 'pyproject.toml') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Cache pytest-testmon data
      uses: actions/cache@v4
      id: testmon-cache
      with:
        path: |
          .testmondata
          .coverage
        key: testmon-${{ runner.os }}-${{ github.ref }}-${{ github.sha }}
        restore-keys: |
          testmon-${{ runner.os }}-${{ github.ref }}-
          testmon-${{ runner.os }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -e .[dev]

    - name: Determine test selection strategy
      id: test-strategy
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] && [[ "${{ github.event.inputs.force_full_suite }}" == "true" ]]; then
          echo "strategy=full" >> $GITHUB_OUTPUT
          echo "Running full test suite (manual trigger)"
        elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
          echo "strategy=smart" >> $GITHUB_OUTPUT
          echo "Using smart test selection (pull request)"
        else
          echo "strategy=smart" >> $GITHUB_OUTPUT
          echo "Using smart test selection (main/develop branch)"
        fi

    - name: Run smart test selector
      if: steps.test-strategy.outputs.strategy == 'smart'
      run: |
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          BASE_BRANCH="origin/${{ github.base_ref }}"
        else
          BASE_BRANCH="HEAD~1"
        fi
        echo "Comparing against: $BASE_BRANCH"
        venv/bin/python scripts/smart_test_selector.py \
          --base-branch "$BASE_BRANCH" \
          --verbose \
          --output .pytest-selected-tests.txt

    - name: Run selected tests with coverage (smart selection)
      if: steps.test-strategy.outputs.strategy == 'smart'
      run: |
        if [ -s .pytest-selected-tests.txt ]; then
          # Check if the file contains the NO_TESTS_NEEDED marker
          if grep -q "^# NO_TESTS_NEEDED" .pytest-selected-tests.txt; then
            echo "No additional tests needed - critical path already validated"
            echo "Skipping test run (no Python files changed)"
          else
            echo "Running selected tests:"
            cat .pytest-selected-tests.txt
            venv/bin/pytest $(cat .pytest-selected-tests.txt) \
              --cov=calendarbot_lite \
              --cov-report=xml \
              --cov-report=json \
              -v
          fi
        else
          echo "No specific tests selected, running full suite"
          venv/bin/python tests/ci_test_runner.py --full-regression
        fi

    - name: Run full test suite with coverage (manual trigger)
      if: steps.test-strategy.outputs.strategy == 'full'
      run: |
        venv/bin/python tests/ci_test_runner.py --full-regression

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      if: always() && hashFiles('coverage.xml') != ''
      with:
        file: ./coverage.xml
        flags: full-suite
        name: full-suite-coverage

    - name: Upload test artifacts
      uses: actions/upload-artifact@v4
      if: always() && (hashFiles('coverage.xml') != '' || hashFiles('coverage.json') != '' || hashFiles('pytest-results.xml') != '')
      with:
        name: test-results
        path: |
          coverage.xml
          coverage.json
          pytest-results.xml
        retention-days: 5

  # STAGE 4: Coverage reporting (informational only, threshold enforced in nightly)
  coverage-report:
    name: Coverage Report (~30s)
    runs-on: ubuntu-latest
    needs: [smart-tests-with-coverage]
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need git history to determine changed files

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt', 'pyproject.toml') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -e .[dev]

    - name: Download coverage artifacts
      uses: actions/download-artifact@v4
      continue-on-error: true
      id: download-artifacts
      with:
        name: test-results

    - name: Check if coverage data is available
      id: check-coverage
      run: |
        if [ -f "coverage.json" ]; then
          echo "available=true" >> $GITHUB_OUTPUT
          echo "Coverage data found"
        else
          echo "available=false" >> $GITHUB_OUTPUT
          echo "No coverage data available (no tests were run)"
        fi

    - name: No tests run message
      if: steps.check-coverage.outputs.available == 'false'
      run: |
        echo "============================================================"
        echo "No Tests Run - No Coverage Data Available"
        echo "============================================================"
        echo ""
        echo "The smart test selector determined that no tests needed to"
        echo "run based on the changed files. This typically happens when:"
        echo ""
        echo "  - No Python files in calendarbot_lite/ were changed"
        echo "  - Only non-code files were modified (docs, config, etc.)"
        echo "  - Critical path tests already validated the changes"
        echo ""
        echo "Full test suite validation runs nightly at 2 AM UTC."
        echo "============================================================"

    - name: Display coverage summary (informational)
      if: steps.check-coverage.outputs.available == 'true'
      run: |
        cat > show_coverage.py << 'EOF'
        import json
        import os

        try:
            with open("coverage.json") as f:
                cov = json.load(f)
                total = cov["totals"]["percent_covered"]
                threshold = int(os.environ.get("COVERAGE_THRESHOLD", "70"))

                print("=" * 60)
                print(f"Coverage Report (Informational)")
                print("=" * 60)
                print(f"  Coverage: {total:.2f}%")
                print(f"  Threshold: {threshold}% (enforced in nightly full suite)")
                print("=" * 60)

                if total < threshold:
                    print("")
                    print("NOTE: Coverage is below threshold.")
                    print("This is expected with smart test selection.")
                    print("Full coverage validation runs nightly at 2 AM UTC.")
                    print("")
                else:
                    print(f"‚úì Coverage meets threshold")
                    print("")
        except FileNotFoundError:
            print("No coverage.json found - skipping report")
        except Exception as e:
            print(f"Error reading coverage: {e}")
        EOF
        venv/bin/python show_coverage.py

    - name: Coverage analysis for changed files
      if: steps.check-coverage.outputs.available == 'true'
      continue-on-error: true
      run: |
        cat > changed_files_coverage.py << 'EOF'
        import json
        import subprocess
        import sys
        from pathlib import Path

        def get_changed_files(base_ref="HEAD~1"):
            """Get list of changed Python files."""
            try:
                # Determine base reference
                if "${{ github.event_name }}" == "pull_request":
                    base_ref = "origin/${{ github.base_ref }}"

                result = subprocess.run(
                    ["git", "diff", "--name-only", base_ref, "HEAD"],
                    capture_output=True,
                    text=True,
                    check=False,
                )

                if result.returncode != 0:
                    print(f"Warning: Could not get changed files: {result.stderr}")
                    return []

                # Filter for Python files in calendarbot_lite
                changed = [
                    f for f in result.stdout.splitlines()
                    if f.endswith('.py') and f.startswith('calendarbot_lite/') and Path(f).exists()
                ]
                return changed
            except Exception as e:
                print(f"Error getting changed files: {e}")
                return []

        def get_file_coverage(coverage_data, changed_files):
            """Extract coverage for specific files."""
            files_coverage = {}

            for file_path in changed_files:
                abs_path = str(Path(file_path).resolve())

                # Check in coverage data
                for cov_file, cov_data in coverage_data.get("files", {}).items():
                    if cov_file.endswith(file_path) or file_path in cov_file:
                        covered = cov_data["summary"]["covered_lines"]
                        total = cov_data["summary"]["num_statements"]
                        pct = cov_data["summary"]["percent_covered"]
                        files_coverage[file_path] = {
                            "covered": covered,
                            "total": total,
                            "percent": pct
                        }
                        break

            return files_coverage

        try:
            # Get changed files
            changed_files = get_changed_files()

            if not changed_files:
                print("No Python files changed in calendarbot_lite/ - skipping coverage analysis")
                sys.exit(0)

            # Load coverage data
            with open("coverage.json") as f:
                coverage_data = json.load(f)

            # Get coverage for changed files
            files_coverage = get_file_coverage(coverage_data, changed_files)

            if not files_coverage:
                print("=" * 60)
                print("Changed Files Coverage (No coverage data found)")
                print("=" * 60)
                print(f"Changed files ({len(changed_files)}):")
                for f in changed_files:
                    print(f"  - {f}")
                print("\nNote: These files may not have been tested in this run.")
                print("=" * 60)
            else:
                # Calculate aggregate
                total_covered = sum(f["covered"] for f in files_coverage.values())
                total_statements = sum(f["total"] for f in files_coverage.values())
                avg_coverage = (total_covered / total_statements * 100) if total_statements > 0 else 0

                print("=" * 60)
                print("Changed Files Coverage Analysis")
                print("=" * 60)
                print(f"Changed files tested: {len(files_coverage)}/{len(changed_files)}")
                print(f"Aggregate coverage: {avg_coverage:.1f}% ({total_covered}/{total_statements} lines)")
                print("=" * 60)
                print("\nPer-file coverage:")
                for file_path, cov in sorted(files_coverage.items()):
                    print(f"  {file_path}: {cov['percent']:.1f}% ({cov['covered']}/{cov['total']} lines)")
                print("=" * 60)

                # List untested files
                untested = set(changed_files) - set(files_coverage.keys())
                if untested:
                    print("\nChanged files not tested:")
                    for f in sorted(untested):
                        print(f"  - {f}")
                    print("=" * 60)

        except FileNotFoundError:
            print("No coverage.json found - skipping changed files analysis")
        except Exception as e:
            print(f"Error analyzing changed files coverage: {e}")
            import traceback
            traceback.print_exc()
        EOF
        venv/bin/python changed_files_coverage.py

  # STAGE 5: Deployment readiness (final gate)
  deployment-check:
    name: Deployment Readiness
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [quality, critical-path, smart-tests-with-coverage, coverage-report]
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt', 'pyproject.toml') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -e .[dev]

    - name: Validate calendarbot_lite startup
      run: |
        timeout 30 venv/bin/python -m calendarbot_lite --help || true

    - name: Download all artifacts for deployment package
      uses: actions/download-artifact@v4
      with:
        name: test-results

    - name: Upload deployment artifacts
      uses: actions/upload-artifact@v4
      with:
        name: deployment-artifacts
        path: |
          coverage.xml
        retention-days: 7

  # STAGE 6: Pi Zero 2W Performance Gate (resource-constrained validation)
  pi-performance-gate:
    name: Pi Zero 2W Performance Validation
    runs-on: ubuntu-latest
    needs: [critical-path]
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt', 'pyproject.toml') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -e .[dev]

    - name: Run Pi Zero 2W performance benchmark (resource-constrained)
      timeout-minutes: 10
      run: |
        echo "========================================"
        echo "Pi Zero 2W Performance Gate"
        echo "========================================"
        echo "Platform: x86_64 with Pi Zero 2W resource constraints"
        echo "CPUs: 1.0 core"
        echo "Memory: 512MB"
        echo "Note: Running on native x86_64 with resource limits"
        echo "      (ARM emulation too slow for CI; thresholds adjusted)"
        echo "========================================"
        echo ""

        # Create temporary directory for test
        TEMP_DIR=$(mktemp -d)
        trap "rm -rf ${TEMP_DIR}" EXIT

        # Copy necessary files
        echo "üì¶ Preparing test environment..."
        cp -r calendarbot_lite "${TEMP_DIR}/"
        cp requirements.txt "${TEMP_DIR}/"
        cp pyproject.toml "${TEMP_DIR}/"
        cp tests/ci_performance_benchmark.py "${TEMP_DIR}/"

        # Run benchmark in Docker container with Pi Zero 2W resource constraints
        echo "üöÄ Running performance benchmark with resource limits..."
        echo ""

        # Run with timeout to prevent hanging
        timeout 8m docker run --rm \
          --cpus="1.0" \
          --memory="512m" \
          --memory-swap="512m" \
          -v "${TEMP_DIR}:/app" \
          -w /app \
          python:3.12-slim \
          bash -c "
            set -e
            echo 'üì• Installing dependencies...'
            pip install --quiet --no-cache-dir --prefer-binary -e . psutil

            echo '‚ö° Running 50-event benchmark...'
            python ci_performance_benchmark.py --run fifty --output benchmark_results.json

            echo ''
            echo '‚úÖ Benchmark complete'
          " || {
            echo "‚ùå Performance benchmark failed"
            exit 1
          }

        # Copy results
        cp "${TEMP_DIR}/benchmark_results.json" pi_perf_results.json

        echo ""
        echo "üìä Performance Results:"
        cat pi_perf_results.json | python -m json.tool

    - name: Validate performance thresholds
      run: |
        echo ""
        echo "========================================"
        echo "Validating Pi Zero 2W Performance"
        echo "========================================"

        venv/bin/python scripts/validate_pi_perf.py pi_perf_results.json \
          --max-parse-time 200ms \
          --max-memory-delta 50MB \
          --max-total-memory 150MB \
          --max-overall-time 250ms \
          --verbose

    - name: Upload performance results
      uses: actions/upload-artifact@v4
      if: always() && hashFiles('pi_perf_results.json') != ''
      with:
        name: pi-performance-results
        path: pi_perf_results.json
        retention-days: 30
