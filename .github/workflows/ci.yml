name: CI/CD Pipeline (Fail-Fast Sequential)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      force_full_suite:
        description: 'Force full test suite (skip smart selection)'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: "3.12"
  COVERAGE_THRESHOLD: 70

jobs:
  # STAGE 1: Static analysis (fail fast on code quality issues)
  quality:
    name: Code Quality (lint/type/security)
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt', 'pyproject.toml') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -e .[dev] types-pytz types-python-dateutil

    - name: Run linting
      run: venv/bin/python tests/ci_test_runner.py --lint

    - name: Run type checking
      run: venv/bin/python tests/ci_test_runner.py --type-check

    - name: Run security analysis
      run: venv/bin/python tests/ci_test_runner.py --security

  # STAGE 2: Critical path smoke tests (fail fast on core functionality)
  critical-path:
    name: Critical Path Tests (~2min)
    runs-on: ubuntu-latest
    needs: [quality]
    timeout-minutes: 8

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt', 'pyproject.toml') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -e .[dev]

    - name: Run critical path tests
      run: venv/bin/python tests/ci_test_runner.py --critical-path

    - name: Upload critical path coverage
      uses: codecov/codecov-action@v4
      if: always()
      with:
        file: ./coverage.xml
        flags: critical-path
        name: critical-path-coverage

  # STAGE 3: Smart test selection WITH coverage (single run, no redundancy)
  smart-tests-with-coverage:
    name: Smart Test Suite + Coverage (~2-5min)
    runs-on: ubuntu-latest
    needs: [critical-path]
    timeout-minutes: 45

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for smart test selection

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt', 'pyproject.toml') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Cache pytest-testmon data
      uses: actions/cache@v4
      id: testmon-cache
      with:
        path: |
          .testmondata
          .coverage
        key: testmon-${{ runner.os }}-${{ github.ref }}-${{ github.sha }}
        restore-keys: |
          testmon-${{ runner.os }}-${{ github.ref }}-
          testmon-${{ runner.os }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -e .[dev]

    - name: Determine test selection strategy
      id: test-strategy
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] && [[ "${{ github.event.inputs.force_full_suite }}" == "true" ]]; then
          echo "strategy=full" >> $GITHUB_OUTPUT
          echo "Running full test suite (manual trigger)"
        elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
          echo "strategy=smart" >> $GITHUB_OUTPUT
          echo "Using smart test selection (pull request)"
        else
          echo "strategy=smart" >> $GITHUB_OUTPUT
          echo "Using smart test selection (main/develop branch)"
        fi

    - name: Run smart test selector
      if: steps.test-strategy.outputs.strategy == 'smart'
      run: |
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          BASE_BRANCH="origin/${{ github.base_ref }}"
        else
          BASE_BRANCH="HEAD~1"
        fi
        echo "Comparing against: $BASE_BRANCH"
        venv/bin/python scripts/smart_test_selector.py \
          --base-branch "$BASE_BRANCH" \
          --verbose \
          --output .pytest-selected-tests.txt

    - name: Run selected tests with coverage (smart selection)
      if: steps.test-strategy.outputs.strategy == 'smart'
      run: |
        if [ -s .pytest-selected-tests.txt ]; then
          echo "Running selected tests:"
          cat .pytest-selected-tests.txt
          venv/bin/pytest $(cat .pytest-selected-tests.txt) \
            --cov=calendarbot_lite \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=json \
            -v
        else
          echo "No specific tests selected, running full suite"
          venv/bin/python tests/ci_test_runner.py --full-regression
        fi

    - name: Run full test suite with coverage (manual trigger)
      if: steps.test-strategy.outputs.strategy == 'full'
      run: |
        venv/bin/python tests/ci_test_runner.py --full-regression

    - name: Generate coverage reports
      run: |
        venv/bin/python tests/ci_test_runner.py --coverage-report

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      if: always()
      with:
        file: ./coverage.xml
        flags: full-suite
        name: full-suite-coverage

    - name: Upload test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          htmlcov/
          coverage.xml
          coverage.json
          pytest-results.xml
        retention-days: 5

  # STAGE 4: Performance validation
  pi-performance-gate:
    name: Pi Zero2 Performance Check (~2min)
    runs-on: ubuntu-latest
    needs: [smart-tests-with-coverage]
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt', 'pyproject.toml') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -e .[dev]

    - name: Run Pi Zero2 performance gate (50 events)
      run: |
        venv/bin/python tests/ci_performance_benchmark.py --run fifty --output pi_zero_perf_check.json

    - name: Upload Pi Zero2 performance results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pi-zero2-perf-gate
        path: pi_zero_perf_check.json
        retention-days: 7

  # STAGE 5: Coverage reporting (informational only, threshold enforced in nightly)
  coverage-report:
    name: Coverage Report (~30s)
    runs-on: ubuntu-latest
    needs: [smart-tests-with-coverage]
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt', 'pyproject.toml') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -e .[dev]

    - name: Download coverage artifacts
      uses: actions/download-artifact@v4
      with:
        name: test-results

    - name: Display coverage summary (informational)
      run: |
        cat > show_coverage.py << 'EOF'
        import json
        import os

        try:
            with open("coverage.json") as f:
                cov = json.load(f)
                total = cov["totals"]["percent_covered"]
                threshold = int(os.environ.get("COVERAGE_THRESHOLD", "70"))

                print("=" * 60)
                print(f"Coverage Report (Informational)")
                print("=" * 60)
                print(f"  Coverage: {total:.2f}%")
                print(f"  Threshold: {threshold}% (enforced in nightly full suite)")
                print("=" * 60)

                if total < threshold:
                    print("")
                    print("NOTE: Coverage is below threshold.")
                    print("This is expected with smart test selection.")
                    print("Full coverage validation runs nightly at 2 AM UTC.")
                    print("")
                else:
                    print(f"âœ“ Coverage meets threshold")
                    print("")
        except FileNotFoundError:
            print("No coverage.json found - skipping report")
        except Exception as e:
            print(f"Error reading coverage: {e}")
        EOF
        venv/bin/python show_coverage.py

    - name: Coverage differential analysis (if available)
      continue-on-error: true
      run: |
        venv/bin/python tests/ci_test_runner.py --coverage-diff || echo "Coverage diff not available"

  # STAGE 6: Deployment readiness (final gate)
  deployment-check:
    name: Deployment Readiness
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [quality, critical-path, smart-tests-with-coverage, pi-performance-gate, coverage-report]
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt', 'pyproject.toml') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -e .[dev]

    - name: Validate calendarbot_lite startup
      run: |
        timeout 30 venv/bin/python -m calendarbot_lite --help || true

    - name: Download all artifacts for deployment package
      uses: actions/download-artifact@v4
      with:
        name: test-results

    - name: Upload deployment artifacts
      uses: actions/upload-artifact@v4
      with:
        name: deployment-artifacts
        path: |
          htmlcov/
          coverage.xml
        retention-days: 7
