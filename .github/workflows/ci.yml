name: CI/CD Pipeline (Optimized)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.9"
  COVERAGE_THRESHOLD: 70

jobs:
  # Quick feedback - Critical path tests (runs on every commit)
  critical-path:
    name: Critical Path Tests (<3min target)
    runs-on: ubuntu-latest
    timeout-minutes: 8

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    # OPTIMIZATION: Cache the entire venv directory
    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    # OPTIMIZATION: Consolidated pip install, only runs on cache miss
    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        # venv/bin/python handles activation
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -r requirements.txt pytest pytest-asyncio pytest-cov pytest-mock pytest-timeout ruff mypy bandit

    - name: Verify cache restoration
      run: |
        # venv/bin/python handles activation
        python --version
        pip --version

    - name: Install package in editable mode
      run: |
        venv/bin/pip install -e .

    - name: Run critical path tests
      run: |
        venv/bin/python tests/ci_test_runner.py --critical-path

    - name: Upload coverage reports (critical path)
      uses: codecov/codecov-action@v4
      if: always()
      with:
        file: ./coverage.xml
        flags: critical-path
        name: critical-path-coverage

  # Code quality checks
  quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    # OPTIMIZATION: Reuse venv cache
    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        # venv/bin/python handles activation
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -r requirements.txt ruff mypy bandit types-pytz types-python-dateutil

    - name: Install package in editable mode
      run: |
        venv/bin/pip install -e .

    - name: Run linting
      run: venv/bin/python tests/ci_test_runner.py --lint

    - name: Run type checking
      run: venv/bin/python tests/ci_test_runner.py --type-check

    - name: Run security analysis
      run: venv/bin/python tests/ci_test_runner.py --security

  # Full test suite (only on pull requests and main branch)
  full-tests:
    name: Full Test Suite
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    timeout-minutes: 45

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    # OPTIMIZATION: Reuse venv cache
    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        # venv/bin/python handles activation
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -r requirements.txt pytest pytest-asyncio pytest-cov pytest-mock pytest-timeout

    - name: Run full test suite
      run: |
        # venv/bin/python handles activation
        venv/bin/python tests/ci_test_runner.py --full-regression

    - name: Generate coverage report
      run: |
        # venv/bin/python handles activation
        venv/bin/python tests/ci_test_runner.py --coverage-report

    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      if: always()
      with:
        file: ./coverage.xml
        flags: full-suite
        name: full-suite-coverage

    - name: Upload test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          htmlcov/
          coverage.xml
          coverage.json
          pytest-results.xml
        retention-days: 5

  # Pi Zero2 Performance Gate (critical for resource-constrained deployment)
  pi-performance-gate:
    name: Pi Zero2 Performance Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    # OPTIMIZATION: Reuse venv cache
    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        # venv/bin/python handles activation
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -r requirements.txt

    - name: Run Pi Zero2 performance gate (50 events)
      run: |
        # venv/bin/python handles activation
        venv/bin/python tests/ci_performance_benchmark.py --run fifty --output pi_zero_perf_check.json

    - name: Upload Pi Zero2 performance results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pi-zero2-perf-gate
        path: pi_zero_perf_check.json
        retention-days: 7

  # Coverage enforcement (blocks merge if coverage drops)
  coverage-gate:
    name: Coverage Enforcement
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [critical-path, full-tests]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    # OPTIMIZATION: Reuse venv cache
    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        # venv/bin/python handles activation
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -r requirements.txt pytest pytest-asyncio pytest-cov

    - name: Validate coverage threshold
      run: |
        # venv/bin/python handles activation
        venv/bin/python tests/ci_test_runner.py --coverage --coverage-fail-under ${{ env.COVERAGE_THRESHOLD }}

    - name: Coverage differential analysis
      run: |
        # venv/bin/python handles activation
        venv/bin/python tests/ci_test_runner.py --coverage-diff

  # Security tests (always run on PRs)
  security:
    name: Security Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    # OPTIMIZATION: Reuse venv cache
    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        # venv/bin/python handles activation
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -r requirements.txt bandit

    - name: Run security tests
      run: |
        # venv/bin/python handles activation
        venv/bin/python tests/ci_test_runner.py --security

  # Deployment readiness check
  deployment-check:
    name: Deployment Readiness
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [critical-path, quality, full-tests, pi-performance-gate, security]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    # OPTIMIZATION: Reuse venv cache
    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        # venv/bin/python handles activation
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -r requirements.txt

    - name: Validate calendarbot_lite startup
      run: |
        # venv/bin/python handles activation
        timeout 30 venv/bin/python -m calendarbot_lite --help || true

    - name: Upload deployment artifacts
      uses: actions/upload-artifact@v4
      with:
        name: deployment-artifacts
        path: |
          htmlcov/
          coverage.xml
        retention-days: 7