# GitHub Copilot Agent Environment Setup
#
# This workflow configures the Copilot coding agent environment to match
# the CalendarBot development environment with all necessary dependencies,
# tools, and configuration.
#
# Documentation:
# - GitHub Copilot Setup: https://docs.github.com/en/copilot/how-tos/use-copilot-agents/coding-agent/customize-the-agent-environment
# - Project-Specific Guidance: .github/copilot-instructions.md (QUICK REFERENCE)
# - Comprehensive Guide: AGENTS.md
# - Custom Agents: .github/agents/README.md
#
# Key Features:
# 1. Python 3.12 with virtual environment
# 2. Dependency caching (matching ci.yml strategy)
# 3. Pre-commit hooks installation
# 4. Environment variables from GitHub secrets
# 5. Development tools (ruff, mypy, bandit)

name: Copilot Environment Setup

# Automatically run the setup steps when they are changed to allow for easy validation, and
# allow manual testing through the repository's "Actions" tab
on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml

# Prevent duplicate workflow runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"

jobs:
  # The job MUST be called `copilot-setup-steps` or it will not be picked up by Copilot.
  copilot-setup-steps:
    name: Setup Copilot Environment
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: copilot  # Access secrets from the "copilot" environment

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for git operations

    - name: Set up Python with dependencies
      uses: ./.github/actions/setup-python
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        install-dev: 'true'
        use-uv: 'true'

    - name: Install additional type stubs
      run: |
        pip install --prefer-binary types-pytz types-python-dateutil

    # Install and configure pre-commit
    - name: Install pre-commit hooks
      run: |
        # Ensure pre-commit is installed (should be in dev dependencies)
        pip install pre-commit
        # Install git hooks from .pre-commit-config.yaml
        pre-commit install --install-hooks
        # Verify installation
        pre-commit --version
        echo "Pre-commit hooks installed successfully"

    # Configure environment variables from GitHub secrets
    - name: Setup environment variables
      run: |
        cat > .env << 'EOF'
        # CalendarBot Environment Configuration for Copilot
        # Generated from GitHub Actions secrets

        # ICS Calendar URL (Required)
        CALENDARBOT_ICS_URL=${{ vars.CALENDARBOT_ICS_URL || 'https://outlook.office365.com/owa/calendar/example/calendar.ics' }}

        # Server Configuration
        CALENDARBOT_WEB_HOST=0.0.0.0
        CALENDARBOT_WEB_PORT=8080
        CALENDARBOT_REFRESH_INTERVAL=300

        # Alexa Integration (Optional)
        CALENDARBOT_ALEXA_BEARER_TOKEN=${{ secrets.CALENDARBOT_ALEXA_BEARER_TOKEN || '' }}

        # Development Settings
        CALENDARBOT_DEBUG=true
        CALENDARBOT_LOG_LEVEL=DEBUG
        CALENDARBOT_NONINTERACTIVE=true

        # CI/Testing Settings
        CALENDARBOT_TEST_TIME=2025-11-05T12:00:00
        EOF

        echo "Environment configuration created"
        echo "Note: Using secrets if available, otherwise using safe defaults"

    # Verify development environment is functional
    - name: Verify environment setup
      run: |
        echo "=== Environment Verification ==="
        echo "Python version:"
        python --version

        echo -e "\nPip packages:"
        pip list | grep -E "(pytest|ruff|mypy|bandit|pre-commit)" || true

        echo -e "\nPre-commit hooks:"
        pre-commit --version
        pre-commit run --all-files --hook-stage manual trailing-whitespace || true

        echo -e "\nCalendarBot modules:"
        python -c "import calendarbot_lite; print(f'calendarbot_lite imported successfully from {calendarbot_lite.__file__}')"

        echo -e "\n=== Setup Complete ==="
        echo "âœ… Python 3.12 configured"
        echo "âœ… Virtual environment with cached dependencies"
        echo "âœ… Pre-commit hooks installed"
        echo "âœ… Environment variables configured"
        echo "âœ… Development tools available (ruff, mypy, bandit)"
        echo ""
        echo "Ready for Copilot coding session!"

    # Cache test data and pytest cache for faster test runs
    - name: Cache pytest data
      uses: actions/cache@v4
      with:
        path: |
          .pytest_cache
          .testmondata
          .coverage
        key: pytest-${{ runner.os }}-${{ github.ref }}-${{ github.sha }}
        restore-keys: |
          pytest-${{ runner.os }}-${{ github.ref }}-
          pytest-${{ runner.os }}-

    # Provide helpful summary
    - name: Environment Summary
      run: |
        cat << 'EOF'

        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘  GitHub Copilot Environment Setup Complete                     â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        ðŸ“¦ Dependencies: Installed and cached
        ðŸ”§ Tools: ruff, mypy, bandit, pytest, pre-commit
        ðŸ”‘ Environment: .env configured from secrets
        ðŸª Pre-commit: Hooks installed and ready

        ðŸš€ Quick Commands:

          # Run tests
          pytest tests/lite/ -v
          ./run_lite_tests.sh

          # Run linting
          ruff check calendarbot_lite
          ruff format calendarbot_lite

          # Type checking
          mypy calendarbot_lite

          # Security scan
          bandit -r calendarbot_lite

          # Pre-commit (manual)
          pre-commit run --all-files

          # Start server
          python -m calendarbot_lite

        ðŸ“š Documentation:
          - .github/copilot-instructions.md - Copilot agent guidance (QUICK REFERENCE)
          - AGENTS.md - Comprehensive development guide
          - CLAUDE.md - Quick reference for Claude Code
          - README.md - Project overview
          - .github/agents/README.md - Custom agent documentation
          - .env.example - Environment variable reference

        ðŸŽ¯ Active Development:
          - calendarbot_lite/ - Main codebase (ALL development here)
          - kiosk/ - Raspberry Pi kiosk deployment (PRIMARY use case)
          - calendarbot/ - Archived legacy code (DO NOT MODIFY)

        âš ï¸  Required Secrets (configure in repo settings):
          - CALENDARBOT_ICS_URL (required for calendar operations)
          - CALENDARBOT_ALEXA_BEARER_TOKEN (optional, for Alexa testing)

        ðŸ“– For Complete Guidance:
          - Start with .github/copilot-instructions.md for quick reference
          - See AGENTS.md for comprehensive development patterns
          - Review test quality standards in docs/pytest-best-practices.md

        EOF
