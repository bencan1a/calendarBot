name: Kiosk E2E Installation Tests

on:
  schedule:
    # Run every night at 3 AM UTC (1 hour after full suite)
    - cron: '0 3 * * *'
  workflow_dispatch:
    # Manual trigger also available

env:
  PYTHON_VERSION: "3.12"

jobs:
  kiosk-e2e-tests:
    name: Kiosk E2E Installation Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python with dependencies
      uses: ./.github/actions/setup-python
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        install-dev: 'true'
        use-uv: 'true'

    - name: Install E2E test dependencies
      run: |
        pip install -e .[e2e]

    - name: Build E2E Docker image
      run: |
        echo "========================================"
        echo "Building Kiosk E2E Docker Image"
        echo "========================================"
        echo "Image: calendarbot-e2e:ci"
        echo "Base: debian:bookworm (systemd-enabled)"
        echo "Purpose: E2E kiosk installation testing"
        echo "========================================"
        echo ""

        docker build -f tests/kiosk/Dockerfile.e2e -t calendarbot-e2e:ci .

        echo ""
        echo "âœ“ E2E Docker image built successfully"
        docker images | grep calendarbot-e2e

    - name: Run E2E Isolation Tests
      timeout-minutes: 20
      run: |
        echo "========================================"
        echo "Running Kiosk E2E Isolation Tests"
        echo "========================================"
        echo "Tests: 6 section-specific isolation tests"
        echo "Duration: ~10-15 minutes (installs packages in containers)"
        echo "========================================"
        echo ""

        venv/bin/pytest tests/kiosk/test_installer.py::TestInstallerE2E \
          -v \
          --tb=short \
          --junit-xml=e2e-isolation-test-results.xml

    - name: Run E2E Progressive Installation Test
      timeout-minutes: 15
      run: |
        echo "========================================"
        echo "Running Progressive Installation Test"
        echo "========================================"
        echo "Tests: Full installation + runtime validation"
        echo "Duration: ~5-7 minutes (single install + API tests)"
        echo "========================================"
        echo ""

        venv/bin/pytest tests/kiosk/test_installer.py::TestProgressiveInstallation \
          -v \
          --tb=short \
          --junit-xml=e2e-progressive-test-results.xml

    - name: Upload isolation test results
      uses: actions/upload-artifact@v4
      if: always() && hashFiles('e2e-isolation-test-results.xml') != ''
      with:
        name: e2e-isolation-test-results
        path: e2e-isolation-test-results.xml
        retention-days: 7

    - name: Upload progressive test results
      uses: actions/upload-artifact@v4
      if: always() && hashFiles('e2e-progressive-test-results.xml') != ''
      with:
        name: e2e-progressive-test-results
        path: e2e-progressive-test-results.xml
        retention-days: 7
