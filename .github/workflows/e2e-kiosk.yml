name: Kiosk E2E Installation Tests

on:
  schedule:
    # Run every night at 3 AM UTC (1 hour after full suite)
    - cron: '0 3 * * *'
  workflow_dispatch:
    # Manual trigger also available

env:
  PYTHON_VERSION: "3.12"

jobs:
  kiosk-e2e-tests:
    name: Kiosk E2E Installation Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache virtual environment
      uses: actions/cache@v4
      id: venv-cache
      with:
        path: venv
        key: venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt', 'pyproject.toml') }}
        restore-keys: |
          venv-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

    - name: Create virtual environment
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: python -m venv venv

    - name: Set venv in PATH
      run: |
        echo "$PWD/venv/bin" >> $GITHUB_PATH
        echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV

    - name: Install dependencies
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: |
        pip install --upgrade pip setuptools wheel
        pip install --prefer-binary -e .[dev]

    - name: Install E2E test dependencies
      run: |
        pip install -e .[e2e]

    - name: Build E2E Docker image
      run: |
        echo "========================================"
        echo "Building Kiosk E2E Docker Image"
        echo "========================================"
        echo "Image: calendarbot-e2e:ci"
        echo "Base: debian:bookworm (systemd-enabled)"
        echo "Purpose: E2E kiosk installation testing"
        echo "========================================"
        echo ""

        docker build -f tests/kiosk/Dockerfile.e2e -t calendarbot-e2e:ci .

        echo ""
        echo "âœ“ E2E Docker image built successfully"
        docker images | grep calendarbot-e2e

    - name: Run E2E tests
      timeout-minutes: 20
      run: |
        echo "========================================"
        echo "Running Kiosk E2E Installation Tests"
        echo "========================================"
        echo "Tests: 6 comprehensive E2E installation tests"
        echo "Duration: ~10-15 minutes (installs packages in containers)"
        echo "========================================"
        echo ""

        venv/bin/pytest tests/kiosk/test_installer.py::TestInstallerE2E \
          -v \
          --tb=short \
          --junit-xml=e2e-test-results.xml

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always() && hashFiles('e2e-test-results.xml') != ''
      with:
        name: e2e-test-results
        path: e2e-test-results.xml
        retention-days: 7
