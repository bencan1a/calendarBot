name: "Performance Smoke Test"

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 0' # weekly UTC

jobs:
  perf_smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Create virtual environment
        run: |
          python -m venv venv
          echo "VIRTUAL_ENV=$PWD/venv" >> $GITHUB_ENV
          echo "$PWD/venv/bin" >> $GITHUB_PATH
          
      - name: Install dependencies
        run: |
          . venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Run performance harness (50 events)
        run: |
          . venv/bin/activate
          export PYTHONPATH="${PYTHONPATH}:${PWD}"
          python tests/ci_performance_benchmark.py --run fifty --output calendarbot_lite_perf_results.json
          
      - name: Upload performance results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: perf-results-${{ github.run_id }}
          path: calendarbot_lite_perf_results.json
          retention-days: 30
