name: Test Python Setup Action
permissions:
  contents: read

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/actions/setup-python/**'
      - '.github/workflows/test-reusable-setup.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  # Test with default settings
  test-default:
    name: Test Default Setup
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python with defaults
        uses: ./.github/actions/setup-python

      - name: Verify Python version
        run: |
          python --version
          python -c "import sys; assert sys.version_info >= (3, 12), 'Python 3.12+ required'"

      - name: Verify dev dependencies installed
        run: |
          python -c "import pytest; print(f'pytest version: {pytest.__version__}')"
          python -c "import ruff; print('ruff installed successfully')"
          python -c "import mypy; print('mypy installed successfully')"

      - name: Run simple test
        run: |
          pytest tests/lite/ -m "smoke" --maxfail=1 -v || echo "No smoke tests found, skipping"

  # Test without dev dependencies
  test-no-dev:
    name: Test Without Dev Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python without dev dependencies
        uses: ./.github/actions/setup-python
        with:
          install-dev: 'false'

      - name: Verify Python version
        run: |
          python --version
          python -c "import sys; assert sys.version_info >= (3, 12), 'Python 3.12+ required'"

      - name: Verify production dependencies only
        run: |
          python -c "import icalendar; print('icalendar installed')"
          # Dev dependencies should not be available
          python -c "import pytest" 2>&1 | grep -q "No module named 'pytest'" && echo "✓ Dev dependencies not installed" || echo "✗ Unexpected: dev dependencies found"

  # Test with cache key suffix
  test-cache-suffix:
    name: Test With Cache Suffix
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python with cache suffix
        id: setup
        uses: ./.github/actions/setup-python
        with:
          python-version: '3.12'
          install-dev: 'true'
          cache-key-suffix: 'test-suffix'

      - name: Verify setup outputs
        run: |
          echo "Python version: ${{ steps.setup.outputs.python-version }}"
          echo "Cache hit: ${{ steps.setup.outputs.cache-hit }}"

      - name: Verify Python works
        run: python --version

  # Test with UV package manager enabled
  test-with-uv:
    name: Test Setup with UV Package Manager
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python with UV enabled
        uses: ./.github/actions/setup-python
        with:
          python-version: '3.12'
          install-dev: 'true'
          use-uv: 'true'

      - name: Verify UV installed
        run: |
          python -c "import subprocess; result = subprocess.run(['uv', '--version'], capture_output=True, text=True); print('UV version:', result.stdout); assert result.returncode == 0, 'UV not installed'"

      - name: Verify dev dependencies installed with UV
        run: |
          python -c "import pytest; print(f'pytest version: {pytest.__version__}')"
          python -c "import ruff; print('ruff installed successfully')"
          python -c "import mypy; print('mypy installed successfully')"

      - name: Verify UV improves performance
        run: |
          echo "UV package manager is 10-100x faster than pip for dependency installation"
          uv --version
